<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0a1b2e" />
  <title>Whylee — Leaderboard</title>

  <!-- PWA & icons -->
  <link rel="manifest" href="/site.webmanifest?v=7006" />
  <link rel="icon" href="/media/icons/favicon-32.png" sizes="32x32" />
  <link rel="apple-touch-icon" href="/media/icons/whylee-icon-192.png" />

  <!-- Preload sprite (avatars & badges) -->
  <link rel="preload" href="/media/avatars/avatars-sprite.svg" as="image" />

  <!-- Styles -->
  <link rel="stylesheet" href="/styles/style.css?v=7006" />
  <link rel="stylesheet" href="/styles/animations.css?v=7006" />
  <link rel="stylesheet" href="/styles/avatar.css?v=7006" />
  <link rel="stylesheet" href="/styles/avatar-badge.css?v=7006" />
  <style>
    .page   { max-width: 1040px; margin: 0 auto; padding: 20px; }
    header  { display:flex; align-items:center; justify-content:space-between; }
    .board  { margin-top: 18px; }
    .row    { display:grid; grid-template-columns: 64px 1fr auto auto; gap:14px;
              align-items:center; padding:12px 14px; border-radius:14px;
              border:1px solid rgba(255,255,255,.06); background:rgba(255,255,255,.04); }
    .row + .row { margin-top: 10px; }
    .name   { font-weight: 600; }
    .muted  { opacity:.7; }
    .rank   { width:38px; text-align:center; font-weight:700; }
    .chips  { display:flex; gap:8px; align-items:center; }
    .chip   { font-size:.85rem; padding:.25rem .5rem; border-radius:999px; background:#0f2b49; border:1px solid rgba(255,255,255,.08); }
  </style>
</head>
<body class="theme-dark">
  <div class="page">
    <header>
      <a href="/index.html" class="brand">Whylee</a>
      <nav>
        <a href="/profile.html" class="link">Profile</a>
      </nav>
    </header>

    <h1 style="margin:18px 0 10px">Leaderboard</h1>
    <div id="board" class="board" role="list"></div>
  </div>

  <!-- Avatar rendering -->
  <script type="module" src="/scripts/ui/avatar.js?v=7006"></script>

  <!-- Leaderboard data + render -->
  <script type="module">
    import { renderAvatar } from '/scripts/ui/avatar.js?v=7006';

    async function fetchLeaderboardFromFunction() {
      const res = await fetch('/.netlify/functions/fetchLeaderboard', { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to fetch leaderboard');
      return await res.json();
    }

    function makeRow(idx, user) {
      // container
      const row = document.createElement('div');
      row.className = 'row';
      row.setAttribute('role', 'listitem');

      // avatar (sprite-based)
      const av = document.createElement('div');
      av.className = 'avatar-wrap';
      av.setAttribute('aria-label', `${user.name} — ${user.tier} subscriber, streak ${user.streak}`);
      av.dataset.tier     = user.tier;                             // 'free' | 'pro' | 'leader'
      av.dataset.name     = user.name;
      av.dataset.progress = user.progress;                         // 0..100
      av.dataset.sprite   = user.sprite || (user.tier === 'pro' ? 'avatar-pro-gold' : 'avatar-default');
      if (user.tier !== 'free') av.dataset.badge = user.badge || (user.tier === 'leader' ? 'crown-gold' : 'crown-gold');

      // name/stats
      const info = document.createElement('div');
      const name = document.createElement('div'); name.className='name'; name.textContent = user.name;
      const meta = document.createElement('div'); meta.className='muted';
      meta.textContent = `Streak ${user.streak} • ${user.total} total • ${user.accuracy}% accuracy`;
      info.append(name, meta);

      // rank + chips
      const rank = document.createElement('div'); rank.className = 'rank'; rank.textContent = `#${idx+1}`;

      const chips = document.createElement('div'); chips.className = 'chips';
      if (user.tier === 'pro') chips.append(elChip('PRO'));
      if (user.perfect) chips.append(elChip('Perfect'));
      chips.append(elChip(`${user.accuracy}%`));

      row.append(av, info, rank, chips);
      // render avatar visuals
      renderAvatar(av);
      return row;
    }

    function elChip(text) { const s=document.createElement('span'); s.className='chip'; s.textContent=text; return s; }

    // Load + render
    (async () => {
      const board = document.getElementById('board');
      let rows;
      try {
        rows = await fetchLeaderboardFromFunction();
      } catch (e) {
        console.error(e);
        // fallback sample
        rows = [
          { name:'Tom', tier:'pro', streak:12, total:2840, accuracy:96, sprite:'avatar-pro-gold', progress:42, perfect:true, badge:'crown-gold' },
          { name:'Ava', tier:'leader', streak:9, total:1710, accuracy:93, sprite:'avatar-leader',   progress:33, perfect:false, badge:'crown-gold' },
          { name:'Kai', tier:'free', streak:5, total:960, accuracy:88, sprite:'avatar-default',      progress:22, perfect:false }
        ];
      }
      rows.slice(0, 50).forEach((u, i) => board.appendChild(makeRow(i, u)));
    })();
  </script>
</body>
</html>
