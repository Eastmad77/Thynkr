<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Whylee CSP/Firebase/Posters Check</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .ok { color: #0a0; }
    .bad { color: #b00; }
    .card { border: 1px solid #ccc; padding: 1rem; border-radius: 8px; max-width: 840px; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; }
    #posterMount { margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>✅ Whylee – CSP / Firebase / Posters sanity check</h1>
  <div class="card">
    <h3>Status</h3>
    <ul id="status">
      <li id="s-config">firebaseConfig present …</li>
      <li id="s-bridge">firebase-bridge loaded …</li>
      <li id="s-gstatic">connect to www.gstatic.com …</li>
      <li id="s-gapi">connect to www.googleapis.com …</li>
      <li id="s-posters">load /posters.json …</li>
      <li id="s-image">load poster image …</li>
    </ul>
    <div id="posterMount"></div>
    <h3>Console</h3>
    <div class="log" id="log"></div>
  </div>
  <script type="module" src="/scripts/firebase-config.js?v=9007"></script>
  <script type="module" src="/scripts/firebase-bridge.js?v=9007"></script>
  <script type="module" src="/scripts/posters.js?v=9007"></script>
  <script type="module">
    const logEl = document.getElementById('log');
    const status = id => document.getElementById(id);
    const ok = (el,msg='OK')=>{el.className='ok';el.textContent=el.textContent.replace('…','')+' '+msg;}
    const bad=(el,msg)=>{el.className='bad';el.textContent=el.textContent.replace('…','')+' '+msg;}
    const log=(msg)=>{console.log(msg);logEl.textContent+=msg+'\\n';};

    try{ if(window.firebaseConfig) ok(status('s-config'),'found'); else throw 'missing'; }
    catch(e){ bad(status('s-config'),e); }

    try{ ok(status('s-bridge'),'loaded'); } catch(e){ bad(status('s-bridge'),e); }

    try{ await fetch('https://www.gstatic.com/generate_204',{mode:'no-cors'}); ok(status('s-gstatic'),'ok'); }
    catch(e){ bad(status('s-gstatic'),'blocked'); log(e); }

    try{ await fetch('https://www.googleapis.com/generate_204',{mode:'no-cors'}); ok(status('s-gapi'),'ok'); }
    catch(e){ bad(status('s-gapi'),'blocked'); log(e); }

    try{
      const res=await fetch('/posters.json?v=9007',{cache:'no-store'});
      const data=await res.json();
      ok(status('s-posters'),`v=${data.v} items=${(data.items||[]).length}`);
      const first=(data.items||[])[0];
      const img=new Image();img.src=first.src;img.onload=()=>ok(status('s-image'),'loaded '+first.id);
      img.onerror=()=>bad(status('s-image'),'failed '+first.src);
      document.getElementById('posterMount').appendChild(img);
      if(window.WhyleePoster?.showPoster) window.WhyleePoster.showPoster(first.id,{autohide:2000});
    }catch(e){ bad(status('s-posters'),e.message); log(e); }
  </script>
</body>
</html>
